---
kind: Vip
apiVersion: kubeovn.io/v1
metadata:
  name: moon-keepalived-vip
spec:
  subnet: vpc2-subnet1
  type: ""

---
kind: KeepAlived
apiVersion: vpn-gw.kubecombo.com/v1
metadata:
  name: vpc2-subnet1-keepalived-01
  namespace: ns1
spec:
  image: icoy/kube-combo-keepalived:v0.0.1
  subnet: vpc2-subnet1
  vipV4: 10.2.0.71
  vipV6: 

# vip is the ip address of vip
# todo:// support duastack 

---
kind: OvnEip
apiVersion: kubeovn.io/v1
metadata:
  name: moon
spec:
  externalSubnet: external
  v4Ip: 172.19.0.11
  type: fip

---
kind: OvnFip
apiVersion: kubeovn.io/v1
metadata:
  name: moon
spec:
  ovnEip: moon
  ipType: vip
  ipName: moon-keepalived-vip

---
kind: VpnGw
apiVersion: vpn-gw.kubecombo.com/v1
metadata:
  name: moon
  namespace: ns1
spec:
  cpu: "1"
  memory: "1024M"
  qosBandwidth: "20"
  replicas: 2 # vrrp 要求至少 2 个节点
  selector:
  tolerations:
  affinity:
  enableSslVpn: false
  sslVpnSecret: ovpnsrv
  dhSecret: ssl-vpn-dh-pem
  sslVpnImage: icoy/kube-combo-openvpn:v0.0.1
  sslVpnCipher: AES-256-GCM
  sslVpnAuth: SHA1
  sslVpnProto: udp
  sslVpnSubnetCidr: 10.240.0.0/16
  enableIpsecVpn: true
  ipsecSecret: ovpn-0-ipsec-vpn
  ipsecVpnImage: icoy/kube-combo-strongswan:v0.0.1
  ipsecSecret: moon-ipsec-vpn
  keepalived: "vpc2-subnet1-keepalived-01"
  
---
kind: IpsecConn
apiVersion: vpn-gw.kubecombo.com/v1
metadata:
  name: moon-sun
  namespace: ns1
spec:
  vpnGw: moon
  # pubkey use cert-manager x509 ca, support ipv4 ipv6
  # psk use pre shared key, not tested
  auth: pubkey
  # default should be safe enough
  proposals: default
  # ike version 0, 1, 2
  ikeVersion: "2"
  localCN: moon.vpn.gw.com
  localPublicIp: 172.19.0.11 
  localPrivateCidrs: 10.1.0.0/24
  remoteCN: sun.vpn.gw.com
  remotePublicIp: 172.19.0.22 
  remotePrivateCidrs: 10.2.0.0/24

---
kind: IpsecConn
apiVersion: vpn-gw.kubecombo.com/v1
metadata:
  name: moon-mars
  namespace: ns1
spec:
  vpnGw: moon
  # pubkey use cert-manager x509 ca, support ipv4 ipv6
  # psk use pre shared key, not tested
  auth: pubkey
  # default should be safe enough
  proposals: default
  # ike version 0, 1, 2
  ikeVersion: "2"
  localCN: moon.vpn.gw.com
  localPublicIp: 172.19.0.11
  localPrivateCidrs: 10.1.0.0/24
  remoteCN: mars.vpn.gw.com
  remotePublicIp: 172.19.0.33
  remotePrivateCidrs: 10.3.0.0/24